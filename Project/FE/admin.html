<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>BookSaw Dashboard</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,0,0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
        integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css" />
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/normalize.css">
    <link rel="stylesheet" type="text/css" href="icomoon/icomoon.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/vendor.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --sidebar-width: 280px;
        }

        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            overflow-y: auto;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-item {
            margin: 0.25rem 1rem;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .main-content {
            margin-left: var(--sidebar-width);
            padding: 2rem;
            min-height: 100vh;
        }

        .header-section {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--secondary-color);
        }

        .content-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-container {
            padding: 1.5rem;
        }

        .search-filters {
            background: #f8f9fa;
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
        }

        .btn-custom {
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            border: none;
            color: white;
        }

        .btn-success-custom {
            background: linear-gradient(135deg, var(--success-color), #229954);
            border: none;
            color: white;
        }

        .btn-warning-custom {
            background: linear-gradient(135deg, var(--warning-color), #d68910);
            border: none;
            color: white;
        }

        .btn-danger-custom {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
            border: none;
            color: white;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
        }

        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }

        .table th {
            background: #f8f9fa;
            border: none;
            font-weight: 600;
            color: var(--primary-color);
        }

        .badge-status {
            padding: 0.5rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-pending {
            background: #fff3cd;
            color: #856404;
        }

        .badge-confirmed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-shipping {
            background: #d4edda;
            color: #155724;
        }

        .badge-delivered {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            .stats-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <div id="header-placeholder"></div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h4 style="color: white;"><i class="fas fa-book"></i> BookSaw Admin</h4>
            <small>Bảng quản lý</small>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-item">
                <div class="nav-link active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt me-2"></i> Bảng quản lý
                </div>
            </div>
            <div class="nav-item">
                <div class="nav-link" data-section="products">
                    <i class="fas fa-book me-2"></i> Sản phẩm
                </div>
            </div>
            <div class="nav-item">
                <div class="nav-link" data-section="categories">
                    <i class="fas fa-tags me-2"></i> Thể loại
                </div>
            </div>
            <div class="nav-item">
                <div class="nav-link" data-section="orders">
                    <i class="fas fa-shopping-cart me-2"></i> Đơn hàng
                </div>
            </div>
            <div class="nav-item">
                <div class="nav-link" data-section="customers">
                    <i class="fas fa-users me-2"></i> Người dùng
                </div>
            </div>
            <div class="nav-item">
                <a class="nav-link" href="index.html">
                    <i class="fas fa-home me-2"></i> Cửa hàng
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header-section">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">Welcome back, Admin!</h2>
                    <p class="text-muted mb-0">Here's what's happening with your bookstore today.</p>
                </div>
                <div class="text-end">
                    <div class="text-muted small">Last updated: <span id="lastUpdate"></span></div>
                </div>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <div id="dashboard-section" class="content-section active">
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h3 class="text-primary" id="totalBooks">0</h3>
                            <p class="mb-0">Tổng số sách</p>
                        </div>
                        <div class="text-primary fs-2">
                            <i class="fas fa-book"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h3 class="text-success" id="totalOrders">0</h3>
                            <p class="mb-0">Tổng đơn hàng</p>
                        </div>
                        <div class="text-success fs-2">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h3 class="text-warning" id="totalCustomers">0</h3>
                            <p class="mb-0">Người dùng</p>
                        </div>
                        <div class="text-warning fs-2">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h3 class="text-info" id="totalRevenue">$0</h3>
                            <p class="mb-0">Total Revenue</p>
                        </div>
                        <div class="text-info fs-2">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Section -->
        <div id="products-section" class="content-section">
            <div class="section-header">
                <h4 style="color: white;"><i class="fas fa-book me-2"></i> Quản Lý Sản Phẩm</h4>
                <button class="btn btn-success-custom btn-custom" onclick="openProductModal()">
                    <i class="fas fa-plus me-1"></i> Thêm sản phẩm
                </button>
            </div>
            <div class="search-filters">
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="productSearch" placeholder="Search products...">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="categoryFilter">
                            <option value="all">All Categories</option>
                            <option value="science">Science</option>
                            <option value="nature">Nature</option>
                            <option value="self-help">Self-help</option>
                            <option value="fantasy">Fantasy</option>
                            <option value="technology">Technology</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary-custom btn-custom w-100" onclick="filterProducts()">
                            <i class="fas fa-search"></i> Tìm
                        </button>
                    </div>
                </div>
            </div>
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Ảnh bìa</th>
                                <th>Tên</th>
                                <th>Tác giả</th>
                                <th>Thể loại</th>
                                <th>Giá</th>
                                <th>Số lượng</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <!-- Products will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Categories Section -->
        <div id="categories-section" class="content-section">
            <div class="section-header">
                <h4 style="color: white;"><i class="fas fa-tags me-2"></i> Quản Lý Thể Loại</h4>
                <button class="btn btn-success-custom btn-custom" onclick="openCategoryModal()">
                    <i class="fas fa-plus me-1"></i> Thêm thể loại
                </button>
            </div>
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Thể loại</th>
                                <th>Mô tả</th>
                                <th>Số lượng sản phẩm</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="categoriesTableBody">
                            <!-- Categories will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Orders Section -->
        <div id="orders-section" class="content-section">
            <div class="section-header">
                <h4 style="color: white;"><i class="fas fa-shopping-cart me-2"></i> Quản Lý Đơn Hàng</h4>
            </div>
            <div class="search-filters">
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="orderSearch"
                            placeholder="Search by order ID or customer...">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="statusFilter">
                            <option value="">Tất cả</option>
                            <option value="pending">Chưa xác nhận</option>
                            <option value="confirmed">Xác nhận</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Khách hàng</th>
                                <th>Ngày</th>
                                <th>Số lượng</th>
                                <th>Tổng tiền</th>
                                <th>Trạng thái</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- Orders will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Customers Section -->
        <div id="customers-section" class="content-section">
            <div class="section-header">
                <h4 style="color: white;"><i class="fas fa-users me-2"></i> Quản Lý Người Dùng</h4>
            </div>
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tên</th>
                                <th>Username</th>
                                <th>Số điện thoại</th>
                                <th>Địa chỉ</th>
                                <th>Role</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody">
                            <!-- Customers will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <!-- Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="productModalTitle">Thêm sản phẩm</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId" name="id">

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="productName" class="form-label">Tên sản phẩm *</label>
                                <input type="text" class="form-control" id="productName" name="name" required>
                            </div>
                            <input type="hidden" id="productAuthorId" name="authorId">
                            <div class="col-md-6 mb-3">
                                <label for="productAuthorName" class="form-label">Tác giả *</label>
                                <input type="text" class="form-control" id="productAuthorName" name="authorName"
                                    placeholder="Nhập tên tác giả" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="categorySelect" class="form-label">Thể loại *</label>
                                <select id="categorySelect" name="categoryId" class="form-select" required>
                                    <option value="">Chọn thể loại</option>
                                    <!-- JS sẽ load option: <option value="3">Science</option> -->
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="productPrice" class="form-label">Giá (₫) *</label>
                                <input type="number" class="form-control" id="productPrice" name="price" step="0.01"
                                    min="0" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="productQuantity" class="form-label">Số lượng *</label>
                                <input type="number" class="form-control" id="productQuantity" name="quantity" min="0"
                                    required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="productImage" class="form-label">URL Ảnh</label>
                            <input type="url" class="form-control" id="productImage" name="image">
                        </div>

                        <div class="mb-3 form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="productActive" name="isActive">
                            <label class="form-check-label" for="productActive">Kích hoạt</label>
                        </div>

                        <div class="mb-3">
                            <label for="productSlug" class="form-label">Slug</label>
                            <input type="text" class="form-control" id="productSlug" name="slug">
                        </div>

                        <div class="mb-3">
                            <label for="productDescription" class="form-label">Mô tả</label>
                            <textarea class="form-control" id="productDescription" name="description"
                                rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="productNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="productNotes" name="notes" rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="productContents" class="form-label">Contents</label>
                            <textarea class="form-control" id="productContents" name="contents" rows="3"></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="productMetaTitle" class="form-label">Meta Title</label>
                                <input type="text" class="form-control" id="productMetaTitle" name="metaTitle">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="productMetaKeyword" class="form-label">Meta Keyword</label>
                                <input type="text" class="form-control" id="productMetaKeyword" name="metaKeyword">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="productMetaDescription" class="form-label">Meta Description</label>
                                <input type="text" class="form-control" id="productMetaDescription"
                                    name="metaDescription">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary-custom btn-custom" onclick="saveProduct()">Lưu</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Category Modal -->
    <div class="modal fade" id="categoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalTitle">Thêm thể loại</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="categoryForm">
                        <input type="hidden" id="categoryId">
                        <div class="mb-3">
                            <label class="form-label">Tên thể loại *</label>
                            <input type="text" class="form-control" id="categoryName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mô tả</label>
                            <textarea class="form-control" id="categoryDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3 form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="categoryActive" checked>
                            <label class="form-check-label" for="categoryActive">Kích hoạt</label>
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary-custom btn-custom"
                        onclick="saveCategory()">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal fade" id="orderModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chi tiết đơn hàng</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="orderModalBody">
                    <!-- Order details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Orders Modal -->
    <div class="modal fade" id="customerOrdersModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerOrdersTitle">Customer Orders</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Date</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="customerOrdersBody">
                                <!-- Customer orders will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="footer-placeholder"></div>
    <div id="footer-bottom-placeholder"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/jquery-1.11.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
        crossorigin="anonymous"></script>
    <script src="js/plugins.js"></script>
    <script src="js/script.js"></script>
    <script type="module" src="assets/js/general.js"></script>

    <script>
        // ==================== PHẦN 1: CẤU HÌNH CHUNG ====================
        const API = "http://127.0.0.1:8080";
        const q = s => document.querySelector(s);
        const qa = s => Array.from(document.querySelectorAll(s));
        const fmtDate = d => new Date(d).toLocaleDateString('vi-VN');

        // ==================== BIẾN TOÀN CỤC ====================
        let productsList = [];
        let categoriesLoaded = false;
        let authorsLoaded = false;

        // ==================== HELPER FUNCTIONS ====================
        // 1) Hàm trả về nguyên Page object
        async function fetchPageObject(url) {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            return res.json();
        }

        // 2) Hàm chỉ lấy content[] (dùng để load list)
        async function fetchPageContent(url) {
            const page = await fetchPageObject(url);
            return page.content || [];
        }

        // 3) Fetch page với error handling tốt hơn
        async function fetchPage(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                return Array.isArray(data) ? data : (data.content || []);
            } catch (error) {
                console.error('Fetch error:', error);
                return [];
            }
        }

        // ==================== NAV TABS ====================
        function showSection(name) {
            qa('.content-section').forEach(s => s.classList.remove('active'));
            q(`#${name}-section`)?.classList.add('active');
        }

        function activateTab(el) {
            qa('.nav-link').forEach(l => l.classList.remove('active'));
            el.classList.add('active');
        }

        function initTabs() {
            qa('.nav-link[data-section]').forEach(link => {
                link.addEventListener('click', () => {
                    activateTab(link);
                    showSection(link.dataset.section);
                });
            });
            const init = q('.nav-link.active');
            if (init) showSection(init.dataset.section);
        }

        // ==================== DASHBOARD STATS ====================
        async function loadDashboardStats() {
            try {
                const prodPage = await fetchPageObject(`${API}/products?page=0&size=1`);
                const custPage = await fetchPageObject(`${API}/customers?role=ROLE_USER&page=0&size=1`);

                // Lấy tất cả đơn về để vừa tính doanh thu, vừa đếm đơn hợp lệ
                const allOrdPage = await fetchPageObject(`${API}/orders?page=0&size=1000`);
                const allOrders = allOrdPage.content || [];

                // Lọc các đơn có ít nhất 1 món
                const validOrders = allOrders.filter(o => (o.totalItems ?? 0) > 0);

                // Cập nhật số liệu lên dashboard
                q('#totalBooks').textContent = prodPage.totalElements || 0;
                q('#totalOrders').textContent = validOrders.length;
                q('#totalCustomers').textContent = custPage.totalElements || 0;

                // Tính doanh thu từ tất cả đơn
                const totalRevenue = allOrders
                    .reduce((sum, o) => sum + (o.totalAmount || 0), 0);
                q('#totalRevenue').textContent = `${totalRevenue.toLocaleString('vi-VN')} ₫`;
            } catch (e) {
                console.error('Error loading dashboard stats:', e);
            }
        }

        // ==================== PRODUCTS MANAGEMENT ====================

        // ✅ HÀM LOAD PRODUCTS DUY NHẤT (loại bỏ loadProducts cũ)
        async function loadProducts() {
            console.log('🔄 Loading products...');

            try {
                const timestamp = Date.now();
                const url = `${API}/products?page=0&size=1000&_t=${timestamp}`;
                console.log('🌐 Fetching from:', url);

                const res = await fetch(url, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });

                console.log(`📡 Load response status: ${res.status}`);

                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }

                const data = await res.json();
                console.log('📦 Received data:', data);

                productsList = data.content || data || [];
                console.log(`✅ Loaded ${productsList.length} products`);

                // Debug: In ra 3 sản phẩm đầu
                productsList.slice(0, 3).forEach(p => {
                    console.log(`📋 Product: ID=${p.id}, Name=${p.name}`);
                });

                renderProducts(productsList);

            } catch (error) {
                console.error('❌ Load products error:', error);
                const tbody = document.querySelector('#productsTableBody');
                if (tbody) {
                    tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Lỗi tải dữ liệu: ${error.message}
                        <br><small>Vui lòng thử lại hoặc kiểm tra kết nối</small>
                    </td>
                </tr>`;
                }
            }
        }
        // ✅ RENDER PRODUCTS
        function renderProducts(list) {
            console.log('🎨 Rendering products, count:', list.length);

            const tbody = document.querySelector('#productsTableBody');
            if (!tbody) {
                console.error('❌ #productsTableBody not found');
                return;
            }

            if (!Array.isArray(list) || list.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">Không có sản phẩm nào</td></tr>`;
                return;
            }

            const html = list.map(p => {
                console.log(`📝 Rendering product ID: ${p.id}, Name: ${p.name}`);
                return `
        <tr data-product-id="${p.id}" id="product-row-${p.id}">
            <td>${p.id}</td>
            <td>
                <img src="${p.image || 'https://via.placeholder.com/60x60?text=No+Image'}" 
                     alt="${p.name}" 
                     style="height:60px; width:60px; object-fit:cover; border-radius:4px;"
                     onerror="this.src='https://via.placeholder.com/60x60?text=No+Image'">
            </td>
            <td><strong>${p.name || ''}</strong></td>
            <td>${p.authorName || 'N/A'}</td>
            <td><span class="badge bg-primary">${p.categoryName || 'N/A'}</span></td>
            <td><strong>${(p.price || 0).toLocaleString('vi-VN')} ₫</strong></td>
            <td>
                <span class="badge ${p.quantity > 0 ? 'bg-success' : 'bg-warning'}">
                    ${p.quantity ?? 0}
                </span>
            </td>
            <td>
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-warning" 
                            onclick="openProductModal(${p.id})" 
                            title="Chỉnh sửa">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" 
                            onclick="deleteProduct(${p.id})" 
                            title="Xóa"
                            data-product-id="${p.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>`;
            }).join('');

            tbody.innerHTML = html;
            console.log('✅ Products rendered successfully');
        }
        // ✅ DELETE PRODUCT - HÀM DUY NHẤT
        async function deleteProduct(id) {
            console.log(`🚀 Starting delete for product ID: ${id}`);

            if (!confirm('Bạn có chắc chắn muốn xoá sản phẩm này?')) {
                console.log('❌ User cancelled delete');
                return;
            }

            // Find button và disable
            const deleteBtn = document.querySelector(`button[onclick="deleteProduct(${id})"]`);
            console.log('🔍 Found delete button:', deleteBtn);

            if (deleteBtn) {
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            try {
                console.log(`🗑️ Sending DELETE request for product ID: ${id}`);
                console.log(`🌐 API URL: ${API}/products/${id}`);

                const res = await fetch(`${API}/products/${id}`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });

                console.log(`📡 Response status: ${res.status}`);
                console.log(`📡 Response ok: ${res.ok}`);

                // 204 = No Content (DELETE success)
                // 200 = OK (DELETE success)
                if (res.status === 204 || res.status === 200 || res.ok) {
                    console.log(`✅ DELETE SUCCESS - Status: ${res.status}`);

                    // === BƯỚC 1: Debug current state ===
                    console.log('📊 Before delete - Products count:', productsList.length);
                    console.log('📊 Product to delete:', productsList.find(p => p.id == id));

                    // === BƯỚC 2: Xóa khỏi array ===
                    const originalLength = productsList.length;
                    productsList = productsList.filter(p => {
                        console.log(`Comparing: ${p.id} != ${id} (${typeof p.id} != ${typeof id})`);
                        return p.id != id; // Dùng != thay vì !== để tránh vấn đề type
                    });

                    console.log(`📊 After filter - Products count: ${originalLength} -> ${productsList.length}`);

                    // === BƯỚC 3: Xóa khỏi DOM ===
                    const row = document.querySelector(`tr[data-product-id="${id}"]`);
                    console.log('🎯 Found table row:', row);

                    if (row) {
                        console.log('🗑️ Removing row from DOM...');
                        row.style.background = '#ffebee'; // Highlight trước khi xóa

                        setTimeout(() => {
                            row.remove();
                            console.log('✅ Row removed from DOM');
                        }, 100);
                    } else {
                        console.log('❌ Table row not found - searching alternatives...');

                        // Thử tìm theo các cách khác
                        const allRows = document.querySelectorAll('#productsTableBody tr');
                        console.log(`🔍 Total rows found: ${allRows.length}`);

                        allRows.forEach((row, index) => {
                            const firstCell = row.querySelector('td:first-child');
                            if (firstCell && firstCell.textContent == id) {
                                console.log(`🎯 Found row by cell content at index ${index}`);
                                row.style.background = '#ffebee';
                                setTimeout(() => row.remove(), 100);
                            }
                        });
                    }

                    // === BƯỚC 4: Re-render toàn bộ table ===
                    console.log('🔄 Re-rendering products table...');
                    renderProducts(productsList);

                    // === BƯỚC 5: Success message ===
                    alert('✅ Xoá sản phẩm thành công!');

                    // === BƯỚC 6: Force reload sau 2s ===
                    setTimeout(async () => {
                        console.log('🔄 Force reloading from server...');
                        await loadProducts();
                        console.log('✅ Reload completed');
                    }, 2000);

                } else {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }

            } catch (error) {
                console.error('❌ Delete error:', error);
                alert(`❌ Lỗi xóa sản phẩm: ${error.message}`);
            } finally {
                // Re-enable button
                if (deleteBtn) {
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                }
            }
        }

        function forceRefreshProducts() {
            console.log('🔄 Force refreshing products...');
            productsList = []; // Clear cache
            loadProducts();
        }

        // ✅ XÓA SẢN PHẨM KHỎI DOM
        function removeProductFromDOM(id) {
            const row = document.querySelector(`tr[data-product-id="${id}"]`);
            if (row) {
                row.style.transition = 'opacity 0.3s ease';
                row.style.opacity = '0.5';
                setTimeout(() => {
                    if (row.parentNode) {
                        row.remove();
                    }
                }, 300);
            }
        }

        // ✅ FILTER PRODUCTS
        function filterProducts() {
            const keyword = q('#productSearch')?.value?.trim()?.toLowerCase() || '';
            const category = q('#categoryFilter')?.value || 'all';

            console.log(`🔍 Filter: keyword="${keyword}", category="${category}"`);

            const filtered = productsList.filter(p => {
                const matchesKeyword = !keyword ||
                    p.name?.toLowerCase().includes(keyword) ||
                    p.authorName?.toLowerCase().includes(keyword);

                const matchesCategory = category === 'all' ||
                    (p.categoryName && p.categoryName.toLowerCase() === category.toLowerCase()) ||
                    (p.categoryId && p.categoryId.toString() === category);

                return matchesKeyword && matchesCategory;
            });

            console.log(`📋 Hiển thị ${filtered.length}/${productsList.length} sản phẩm`);
            renderProducts(filtered);
        }

        function testDeleteProduct(id) {
            console.log('🧪 Testing delete for product ID:', id);
            console.log('🧪 Current products count:', productsList.length);
            console.log('🧪 Product exists:', productsList.find(p => p.id == id));
            console.log('🧪 DOM row exists:', document.querySelector(`tr[data-product-id="${id}"]`));
        }

        window.deleteProduct = deleteProduct;
        window.renderProducts = renderProducts;
        window.loadProducts = loadProducts;
        window.forceRefreshProducts = forceRefreshProducts;
        window.testDeleteProduct = testDeleteProduct;
        // ==================== CATEGORIES ====================
        async function loadCategories() {
            try {
                const [cats, prods] = await Promise.all([
                    fetchPageContent(`${API}/categories?page=0&size=1000`),
                    fetchPageContent(`${API}/products?page=0&size=1000`)
                ]);
                // Đếm số lượng sản phẩm theo thể loại
                const countMapByName = prods.reduce((m, p) => {
                    const key = p.categoryName || 'Unknown';
                    m[key] = (m[key] || 0) + 1;
                    return m;
                }, {});

                q('#categoriesTableBody').innerHTML = cats.map(c => `
            <tr>
              <td>${c.id}</td>
              <td>${c.name}</td>
              <td>${c.metaDescription || ''}</td>
              <td>${countMapByName[c.name] || 0}</td>
              <td>
                <button class="btn btn-sm btn-danger" onclick="deleteCategory(${c.id})">
                  <i class="fas fa-trash"></i> Xoá
                </button>
              </td>
            </tr>
        `).join('');
            } catch (e) {
                console.error(e);
            }
        }

        async function deleteCategory(id) {
            if (!confirm('Bạn có chắc chắn muốn xoá thể loại này?')) return;

            try {
                const res = await fetch(`${API}/categories/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                if (res.status === 204) {
                    alert('Xoá thể loại thành công!');
                    await loadCategories(); // reload lại danh sách
                } else {
                    const errorText = await res.text();
                    throw new Error(errorText || `Lỗi: ${res.status}`);
                }
            } catch (e) {
                alert('Không thể xoá thể loại: ' + e.message);
                console.error('deleteCategory', e);
            }
        }


        async function saveCategory() {
            const id = document.getElementById('categoryId').value;
            const name = document.getElementById('categoryName').value.trim();
            const description = document.getElementById('categoryDescription').value.trim();
            const isActive = document.getElementById('categoryActive')?.checked ?? true; // Luôn lấy giá trị, mặc định true

            // Validate
            if (!name) {
                alert('Tên thể loại không được để trống!');
                return;
            }

            const payload = {
                id: id ? +id : null,
                name: name,
                description: description,
                isActive: isActive
            };

            try {
                const method = id ? 'PUT' : 'POST';
                const url = id ? `${API}/categories/${id}` : `${API}/categories`;
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    credentials: 'include'
                });
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(errorText);
                }
                alert('Lưu thể loại thành công!');
                // Đóng modal, reload lại table
                const categoryModalEl = document.getElementById('categoryModal');
                const categoryModal = bootstrap.Modal.getInstance(categoryModalEl);
                if (categoryModal) categoryModal.hide();
                await loadCategories();
            } catch (e) {
                alert('Không thể lưu thể loại:\n' + e.message);
                console.error(e);
            }
        }

        let categoriesList = [];

        // Mở modal (nếu truyền id thì là edit, không thì là create mới)
        async function openCategoryModal(id = null) {
            const form = document.getElementById('categoryForm');
            form.reset();
            document.getElementById('categoryId').value = id || '';

            // Đặt tiêu đề modal
            document.getElementById('categoryModalTitle').textContent = id ? 'Chỉnh sửa thể loại' : 'Thêm thể loại mới';

            if (id) {
                // Edit mode: load chi tiết category
                try {
                    const res = await fetch(`${API}/categories/${id}`, { credentials: 'include' });
                    if (!res.ok) throw new Error('Không tải được thông tin thể loại');
                    const c = await res.json();
                    document.getElementById('categoryName').value = c.name || '';
                    document.getElementById('categoryDescription').value = c.metaDescription || '';
                } catch (e) {
                    alert('Lỗi tải thông tin thể loại!');
                    return;
                }
            }

            // Hiển thị modal
            const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
            modal.show();
        }
        window.openCategoryModal = openCategoryModal;
        window.saveCategory = saveCategory;
        window.loadCategories = loadCategories;
        window.deleteCategory = deleteCategory;


        // Khởi tạo khi load trang
        document.addEventListener('DOMContentLoaded', loadCategories);

        // ==================== ORDERS ====================
        async function loadOrders() {
            let list = [];
            try {
                list = await fetchPage(`${API}/orders?page=0&size=100`);
            } catch (err) {
                console.error('Lỗi loadOrders():', err);
            }

            const validOrders = list.filter(o => (o.totalItems ?? 0) > 0);
            q('#ordersTableBody').innerHTML = validOrders.map(o => {
                const money = (o.totalMoney ?? 0)
                    || (Array.isArray(o.orderDetails)
                        ? o.orderDetails.reduce((sum, d) => sum + ((d.price || 0) * (d.quantity || 0)), 0)
                        : 0);

                // Tính text và class cho trạng thái
                const statusText = o.isActive === 1 ? 'Xác nhận' : 'Chưa xác nhận';
                const badgeClass = o.isActive === 1 ? 'badge-active' : 'badge-pending';

                return `
          <tr>
            <td>${o.orderCode}</td>
            <td>${o.nameReceiver}</td>
            <td>${fmtDate(o.orderDate)}</td>
            <td>${o.totalItems}</td>
            <td>${money.toLocaleString('vi-VN')} ₫</td>
            <td><span class="badge-status ${badgeClass}">${statusText}</span></td>
            <td>
              <button class="btn btn-sm btn-primary-custom" onclick="viewOrder('${o.orderCode}')">
                <i class="fas fa-eye"></i>
              </button>
            </td>
          </tr>
        `;
            }).join('');
        }

        // ==================== CUSTOMERS ====================
        async function loadCustomers() {
            try {
                const list = await fetchPageContent(`${API}/customers?page=0&size=1000`);
                q('#customersTableBody').innerHTML = list.map(u => `
          <tr>
            <td>${u.id}</td>
            <td>${u.name}</td>
            <td>${u.username}</td>
            <td>${u.phone}</td>
            <td>${u.address}</td>
            <td>${u.role}</td>
            <td>
              <button class="btn btn-sm btn-info" onclick="viewCustomerOrders(${u.id})"><i class="fas fa-eye"></i></button>
            </td>
          </tr>
        `).join('');
            } catch (e) {
                console.error('Error loadCustomers():', e);
            }
        }

        // ==================== MODAL VÀ FORM ====================
        // Load authors cho select trong modal
        async function loadAuthors() {
            if (authorsLoaded) return;

            try {
                console.log('📚 Đang tải danh sách tác giả...');
                const res = await fetch(`${API}/authors?page=0&size=1000`, {
                    credentials: 'include'
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const data = await res.json();
                const sel = q('#authorSelect');

                if (sel) {
                    // Clear existing options except first one
                    sel.innerHTML = '<option value="">-- Chọn tác giả --</option>';

                    data.content?.forEach(a => {
                        const opt = document.createElement('option');
                        opt.value = a.id;
                        opt.textContent = a.name;
                        sel.appendChild(opt);
                    });
                }

                authorsLoaded = true;
                console.log(`✅ Đã tải ${data.content?.length || 0} tác giả`);

            } catch (e) {
                console.error('❌ Lỗi load authors:', e);
            }
        }

        // Load categories cho select trong modal
        async function loadCategoriesForModal() {
            if (categoriesLoaded) return;

            try {
                console.log('📂 Đang tải danh sách danh mục...');
                const res = await fetch(`${API}/categories?page=0&size=1000`, {
                    credentials: 'include'
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const data = await res.json();
                const sel = q('#categorySelect');

                if (sel) {
                    // Clear existing options except first one
                    sel.innerHTML = '<option value="">-- Chọn danh mục --</option>';

                    data.content?.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.id;
                        opt.textContent = c.name;
                        sel.appendChild(opt);
                    });
                }

                categoriesLoaded = true;
                console.log(`✅ Đã tải ${data.content?.length || 0} danh mục`);

            } catch (e) {
                console.error('❌ Lỗi load categories:', e);
            }
        }

        // Load categories cho filter dropdown
        async function loadCategoriesForFilter() {
            try {
                const filterSelect = q('#categoryFilter');
                if (!filterSelect) return;

                // Chỉ load nếu chưa có options
                if (filterSelect.children.length <= 1) {
                    const res = await fetch(`${API}/categories?page=0&size=1000`, {
                        credentials: 'include'
                    });

                    if (res.ok) {
                        const data = await res.json();
                        data.content?.forEach(c => {
                            const opt = document.createElement('option');
                            opt.value = c.id;
                            opt.textContent = c.name;
                            filterSelect.appendChild(opt);
                        });
                    }
                }
            } catch (e) {
                console.error('❌ Lỗi load categories for filter:', e);
            }
        }

        // Mở modal thêm/sửa sản phẩm
        async function openProductModal(id = null) {
            console.log(`📝 Mở modal: ${id ? `Edit ID ${id}` : 'Create new'}`);

            // Khởi tạo Bootstrap Modal nếu chưa có
            const productModalEl = document.getElementById('productModal');
            if (!productModalEl) {
                console.error('❌ Không tìm thấy #productModal');
                return;
            }

            const productModal = new bootstrap.Modal(productModalEl);

            // Reset form
            const form = document.getElementById('productForm');
            if (form) form.reset();

            q('#productId').value = id || '';
            q('#productModalTitle').textContent = id ? 'Chỉnh sửa sản phẩm' : 'Thêm sản phẩm mới';

            // Load dữ liệu cho select
            await Promise.all([
                loadAuthors(),
                loadCategoriesForModal()
            ]);

            if (id) {
                // Edit mode: load chi tiết sản phẩm
                try {
                    const res = await fetch(`${API}/products/${id}`, {
                        credentials: 'include'
                    });

                    if (!res.ok) throw new Error(`HTTP ${res.status}`);

                    const p = await res.json();

                    // Fill form
                    q('#productName').value = p.name || '';
                    q('#productAuthorId').value = p.authorId || '';
                    q('#productAuthorName').value = p.authorName || '';
                    q('#categorySelect').value = p.categoryId || '';
                    q('#productPrice').value = p.price || '';
                    q('#productQuantity').value = p.quantity || '';
                    q('#productImage').value = p.image || '';
                    q('#productActive').checked = p.isActive !== false;
                    q('#productSlug').value = p.slug || '';
                    q('#productDescription').value = p.description || '';
                    q('#productNotes').value = p.notes || '';
                    q('#productContents').value = p.contents || '';
                    q('#productMetaTitle').value = p.metaTitle || '';
                    q('#productMetaKeyword').value = p.metaKeyword || '';
                    q('#productMetaDescription').value = p.metaDescription || '';

                } catch (e) {
                    console.error('❌ Lỗi load product detail:', e);
                    alert('Không thể tải thông tin sản phẩm');
                    return;
                }
            }

            productModal.show();
        }

        // Lưu sản phẩm
        async function saveProduct() {
            const form = document.getElementById('productForm');
            const saveBtn = q('#productModal .btn-primary');

            // Validate form
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Disable button
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang lưu...';
            }

            const id = q('#productId').value;
            const payload = {
                id: id ? +id : null,
                name: q('#productName').value.trim(),
                authorId: +q('#productAuthorId').value || null,
                authorName: q('#productAuthorName').value.trim(),
                categoryId: +q('#categorySelect').value || null,
                price: +q('#productPrice').value || 0,
                quantity: +q('#productQuantity').value || 0,
                image: q('#productImage').value.trim(),
                isActive: q('#productActive').checked,
                slug: q('#productSlug').value.trim(),
                description: q('#productDescription').value.trim(),
                notes: q('#productNotes').value.trim(),
                contents: q('#productContents').value.trim(),
                metaTitle: q('#productMetaTitle').value.trim(),
                metaKeyword: q('#productMetaKeyword').value.trim(),
                metaDescription: q('#productMetaDescription').value.trim()
            };

            try {
                console.log(`💾 ${id ? 'Cập nhật' : 'Tạo mới'} sản phẩm:`, payload);

                const method = id ? 'PUT' : 'POST';
                const url = id ? `${API}/products/${id}` : `${API}/products`;

                const res = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    body: JSON.stringify(payload),
                    credentials: 'include'
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`HTTP ${res.status}: ${errorText}`);
                }

                console.log(`✅ ${id ? 'Cập nhật' : 'Tạo'} sản phẩm thành công`);

                // Đóng modal
                const productModalEl = document.getElementById('productModal');
                const productModal = bootstrap.Modal.getInstance(productModalEl);
                if (productModal) productModal.hide();

                alert(`${id ? 'Cập nhật' : 'Thêm'} sản phẩm thành công!`);

                // Reload danh sách
                await loadProducts();

            } catch (e) {
                console.error('❌ Lỗi saveProduct():', e);
                alert(`Không thể lưu sản phẩm. Lỗi: ${e.message}`);
            } finally {
                // Re-enable button
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = id ? 'Cập nhật' : 'Thêm sản phẩm';
                }
            }
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 Khởi tạo ứng dụng...');

            // Khởi tạo tabs
            initTabs();

            // Load tất cả dữ liệu
            Promise.all([
                loadDashboardStats(),
                loadProducts(),
                loadCategories(),
                loadOrders(),
                loadCustomers()
            ]).then(() => {
                console.log('✅ Đã tải xong tất cả dữ liệu');
                q('#lastUpdate').textContent = new Date().toLocaleString('vi-VN');
            }).catch(err => {
                console.error('❌ Lỗi khởi tạo:', err);
            });

            // Event listeners cho search và filter
            const searchInput = q('#productSearch');
            if (searchInput) {
                searchInput.addEventListener('input', filterProducts);
            }

            const categoryFilter = q('#categoryFilter');
            if (categoryFilter) {
                categoryFilter.addEventListener('change', filterProducts);
            }

            console.log('✅ Khởi tạo hoàn tất');
        });
    </script>